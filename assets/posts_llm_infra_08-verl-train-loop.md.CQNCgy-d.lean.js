import{_ as p,c as l,o as t,ah as n,j as s,a}from"./chunks/framework.CvbyeFFO.js";const w=JSON.parse('{"title":"Verl 训练流程源代码阅读","description":"","frontmatter":{"title":"Verl 训练流程源代码阅读","date":"2025-12-01T10:42:14.000Z","create":"2025-12-01T10:42:14.000Z","categories":["verl"],"tags":["main_ppo","RayPPOTrainer.fit","Rollout","Reward 计算","Old LogProb计算","Ref LogProb计算","CriticValues计算","优势计算","create_rl_dataset","_build_messages","_create_dataloader","Validate","generate_sequences","val_reward_fn","process_validation_metrics","compute_advantage","compute_gae_advantage_return","compute_grpo_outcome_advantage","MegatronPPOActor.compute_log_prob","MegatronPPOActor.forward_backward_batch","forward_step","计算熵","计算label logprobs","Policy Loss 计算","PG Loss计算","compute_policy_loss_vanilla","agg_loss","token-mean","seq-mean-token-mean","MegatronCriticWorker.update_critic","MegatronPPOCriitc.update_critic、forward_backward_batch、forward_step、loss_func","compute_value_loss","core_alogs.py","value clip","update_actor","update_policy","load_reward_manager","NaiveRewardManager","RayPPOTrainer.init_workers","MegatronActorRolloutRefWorker","MegatronActorRolloutRefWorker.init_model"]},"headers":[],"relativePath":"posts/llm/infra/08-verl-train-loop.md","filePath":"posts/llm/infra/08-verl-train-loop.md","lastUpdated":null}'),h={name:"posts/llm/infra/08-verl-train-loop.md"},e={class:"custom-block note"},k={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},r={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.355ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.228ex",height:"1.33ex",role:"img",focusable:"false",viewBox:"0 -431 984.6 588.1","aria-hidden":"true"},d={class:"custom-block tip"},A={tabindex:"0",class:"MathJax",jax:"SVG",display:"true",style:{direction:"ltr",display:"block","text-align":"center",margin:"1em 0",position:"relative"}},B={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"14.901ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 6586.4 1000","aria-hidden":"true"},g={tabindex:"0",class:"MathJax",jax:"SVG",display:"true",style:{direction:"ltr",display:"block","text-align":"center",margin:"1em 0",position:"relative"}},o={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"34.268ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 15146.2 1000","aria-hidden":"true"},y={tabindex:"0",class:"MathJax",jax:"SVG",display:"true",style:{direction:"ltr",display:"block","text-align":"center",margin:"1em 0",position:"relative"}},c={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"32.915ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 14548.6 1000","aria-hidden":"true"},u={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},b={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.357ex"},xmlns:"http://www.w3.org/2000/svg",width:"1.77ex",height:"1.979ex",role:"img",focusable:"false",viewBox:"0 -717 782.3 874.8","aria-hidden":"true"},m={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},F={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.357ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.462ex",height:"1.977ex",role:"img",focusable:"false",viewBox:"0 -716 1088.3 873.8","aria-hidden":"true"};function _(f,i,C,D,E,q){return t(),l("div",null,[i[40]||(i[40]=n("",6)),s("div",e,[i[11]||(i[11]=s("div",{class:"custom-block-title"},"RayPPOTrainer.fit()",-1)),i[12]||(i[12]=s("p",null,[s("strong",null,"0. 核心思想")],-1)),i[13]||(i[13]=s("ul",null,[s("li",null,"RL思想，采样、评估、学习。")],-1)),i[14]||(i[14]=s("p",null,[s("strong",null,"1. Rollout (生成/采样)")],-1)),s("ul",null,[s("li",null,[i[2]||(i[2]=a("使用")),i[3]||(i[3]=s("code",null,"当前策略Actor",-1)),i[4]||(i[4]=a()),s("mjx-container",k,[(t(),l("svg",r,i[0]||(i[0]=[n("",1)]))),i[1]||(i[1]=s("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("mstyle",{mathcolor:"red"},[s("msub",null,[s("mi",null,"π"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"θ")])])])])],-1))]),i[5]||(i[5]=a("，对batch prompts做")),i[6]||(i[6]=s("code",null,"采样",-1)),i[7]||(i[7]=a("，")),i[8]||(i[8]=s("code",null,"生成responses",-1)),i[9]||(i[9]=a("。(环境交互)"))]),i[10]||(i[10]=s("li",null,[a("gen_batch_output = self.async_rollout_manager."),s("code",null,"generate_sequences(gen_batch_output)")],-1))]),i[15]||(i[15]=n("",4))]),i[41]||(i[41]=n("",68)),s("div",d,[i[35]||(i[35]=s("div",{class:"custom-block-title"},"GAE 优势估计",-1)),i[36]||(i[36]=s("p",null,[s("strong",null,"理论笔记")],-1)),i[37]||(i[37]=s("ul",null,[s("li",null,[s("a",{href:"https://plmsmile.github.io/posts/llm/rl/theory/09-policy-trpo-ppo.html#gae-%E6%80%BB%E7%BB%93",target:"_blank",rel:"noreferrer"},"GAE 笔记")])],-1)),i[38]||(i[38]=s("p",null,[s("strong",null,"核心数学公式")],-1)),s("ul",null,[s("li",null,[i[20]||(i[20]=s("p",null,"GAE 反向迭代计算公式",-1)),s("mjx-container",A,[(t(),l("svg",B,i[16]||(i[16]=[n("",1)]))),i[17]||(i[17]=s("mjx-assistive-mml",{unselectable:"on",display:"block",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",overflow:"hidden",width:"100%"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("mstyle",{mathcolor:"blue"},[s("msub",null,[s("mi",null,"A"),s("mi",null,"T")]),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"s"),s("mi",null,"t")]),s("mo",null,","),s("msub",null,[s("mi",null,"a"),s("mi",null,"t")]),s("mo",{stretchy:"false"},")")]),s("mo",null,"="),s("mstyle",{mathcolor:"red"},[s("msub",null,[s("mi",null,"δ"),s("mi",null,"T")])])])],-1))]),s("mjx-container",g,[(t(),l("svg",o,i[18]||(i[18]=[n("",1)]))),i[19]||(i[19]=s("mjx-assistive-mml",{unselectable:"on",display:"block",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",overflow:"hidden",width:"100%"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("mstyle",{mathcolor:"blue"},[s("msub",null,[s("mi",null,"A"),s("mi",null,"t")]),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"s"),s("mi",null,"t")]),s("mo",null,","),s("msub",null,[s("mi",null,"a"),s("mi",null,"t")]),s("mo",{stretchy:"false"},")")]),s("mo",null,"="),s("mstyle",{mathcolor:"red"},[s("msub",null,[s("mi",null,"δ"),s("mi",null,"t")])]),s("mo",null,"+"),s("mstyle",{mathcolor:"blue"},[s("mi",null,"γ"),s("mi",null,"λ")]),s("mstyle",{mathcolor:"red"},[s("msub",null,[s("mi",null,"A"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mn",null,"1")])]),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"s"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mn",null,"1")])]),s("mo",null,","),s("msub",null,[s("mi",null,"a"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mn",null,"1")])]),s("mo",{stretchy:"false"},")")])])],-1))])]),s("li",null,[i[23]||(i[23]=s("p",null,"TD error",-1)),s("mjx-container",y,[(t(),l("svg",c,i[21]||(i[21]=[n("",1)]))),i[22]||(i[22]=s("mjx-assistive-mml",{unselectable:"on",display:"block",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",overflow:"hidden",width:"100%"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[s("mstyle",{mathcolor:"blue"},[s("msub",null,[s("mi",null,"δ"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mi",null,"l")])])]),s("mo",null,"="),s("mstyle",{mathcolor:"red"},[s("msub",null,[s("mi",null,"r"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mi",null,"l")])]),s("mo",null,"+"),s("mi",null,"γ"),s("mi",null,"V"),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"s"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mi",null,"l"),s("mo",null,"+"),s("mn",null,"1")])]),s("mo",{stretchy:"false"},")")]),s("mo",null,"−"),s("mstyle",{mathcolor:"blue"},[s("mi",null,"V"),s("mo",{stretchy:"false"},"("),s("msub",null,[s("mi",null,"s"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t"),s("mo",null,"+"),s("mi",null,"l")])]),s("mo",{stretchy:"false"},")")])])],-1))])])]),i[39]||(i[39]=s("p",null,[s("strong",null,"核心思想")],-1)),s("ul",null,[s("li",null,[i[33]||(i[33]=s("p",null,[s("code",null,"反向迭代"),a("计算每步的优势")],-1)),s("ul",null,[s("li",null,[i[28]||(i[28]=a("计算")),i[29]||(i[29]=s("code",null,"TD_error",-1)),s("mjx-container",u,[(t(),l("svg",b,i[24]||(i[24]=[n("",1)]))),i[25]||(i[25]=s("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("msub",null,[s("mi",null,"δ"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mi",null,"t")])])])],-1))]),i[30]||(i[30]=a("、计算")),i[31]||(i[31]=s("code",null,"优势",-1)),s("mjx-container",m,[(t(),l("svg",F,i[26]||(i[26]=[n("",1)]))),i[27]||(i[27]=s("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("msub",null,[s("mi",null,"A"),s("mi",null,"t")])])],-1))])]),i[32]||(i[32]=s("li",null,[a("对于"),s("code",null,"pad"),a("、"),s("code",null,"环境返回"),a("等位置的值，"),s("code",null,"利用response_mask"),a("，"),s("strong",null,"不做计算"),a("，即"),s("code",null,"当前值不做更新")],-1))])]),i[34]||(i[34]=n("",2))])]),i[42]||(i[42]=n("",136))])}const T=p(h,[["render",_]]);export{w as __pageData,T as default};
